---
import Layout from "./main.astro";
import Navigation from "src/components/Navigation.astro";
import TableOfContentsWrapper from "src/components/TableOfContentsWrapper.astro";
import PostListWrapper from "src/components/PostListWrapper.astro";
import ParticleRing from "src/components/ParticleRing.astro";
import { getCollection } from "astro:content";

interface Props {
  entry: any;
  headings: any[];
}

const { entry, headings } = Astro.props;

// 获取所有文章和项目数据
const posts = await getCollection("post");
const projects = await getCollection("project");
const currentPath = Astro.url.pathname;
const isProjectPage = currentPath.startsWith('/project/');

// 创建日期格式化器
const formatter = new Intl.DateTimeFormat("zh-CN", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// 计算阅读时间的函数
function calculateReadingTime(content: string) {
  const wordsPerMinute = 100;
  const words = content.split(/\s+/).length;
  const minutes = Math.ceil(words / wordsPerMinute);
  return `${minutes} 分钟`;
}
---

<Layout title={entry.data.title}>
  <!-- 背景图片或 Aurora 背景 - 固定在顶部 -->
  <div class="fixed top-0 left-0 w-full h-[50vh] z-0 overflow-hidden">
    {entry.data.image ? (
      <>
        <img 
          src={entry.data.image} 
          alt={entry.data.title}
          class="w-full h-full object-cover object-center"
        />
      </>
    ) : (
      <>
        <ParticleRing />
      </>
    )}
  </div>

  <main class="relative z-10 min-h-screen">
    <!-- 标题区域 - 覆盖在背景图上 -->
    <div class="relative z-20 top-[-100px] min-h-[50vh] flex justify-center inset-0">
       {entry.data.image ? (
      <>
      <!-- 使用缓动曲线渐变减少波浪纹 - Scrim Gradient 技术 -->
        <div class="absolute inset-0 gradient-scrim backdrop-blur-lg"></div>
      </>
    ) : (
      <>
       <div class="absolute"></div>
      </>
    )}
      <div class="w-full max-w-4xl mx-auto absolute bottom-0 px-4 xl:px-0 z-10">
        <h1 class="text-2xl lg:text-3xl font-bold leading-tight text-black dark:text-white mb-4">
          {entry.data.title}
        </h1>
        <div class="text-sm text-black/95 dark:text-white/95 mb-6">
          <span>{formatter.format(new Date(entry.data.dateFormatted))}</span>
          <span class="mx-2">•</span>
          <span>{calculateReadingTime(entry.data.description)} 阅读</span>
        </div>
        {entry.data.tags && entry.data.tags.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {entry.data.tags.map((tag: string) => (
              <a
                href={`/tags/${tag}`}
                class="px-3.5 py-1.5 text-sm rounded-full bg-black/80 dark:bg-white/15 backdrop-blur-md text-white border border-black/40 dark:border-white/20 transition-all duration-200 hover:bg-black/90 dark:hover:bg-white/25 hover:-translate-y-0.5"
                style="text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);"
              >
                #{tag}
              </a>
            ))}
          </div>
        )}
      </div>
    </div>

    <!-- 内容区域 -->
    <div class="relative z-20 bg-background min-h-screen mt-[-100px]">
      <div class="grid grid-cols-1 xl:grid-cols-[240px_1fr_240px] gap-8 mx-auto px-4 xl:px-8 py-12 xl:py-16" id="content-grid">
        <!-- Left Sidebar - Post List -->
        <aside class="hidden xl:block relative" id="left-sidebar-wrapper">
          <div class="sidebar-container p-4 rounded-lg transition-all duration-300 max-h-[calc(100vh-6rem)] overflow-y-auto" id="left-sidebar">
            <h5 class="text-xs font-semibold mb-4 text-foreground uppercase tracking-wider ml-5">文章目录</h5>
            <PostListWrapper />
          </div>
        </aside>

        <!-- Main Content -->
        <article class="w-full max-w-4xl mx-auto">
          <div class="mb-16 prose dark:prose-invert max-w-none">
            <slot />
          </div>
          <Navigation />
        </article>

        <!-- Right Sidebar - Table of Contents -->
        {headings && headings.length > 0 && (
          <aside class="hidden xl:block relative" id="right-sidebar-wrapper">
            <div class="sidebar-container p-4 rounded-lg transition-all duration-300 max-h-[calc(100vh-6rem)] overflow-y-auto" id="right-sidebar">
              <h3 class="text-xs font-semibold mb-4 text-foreground uppercase tracking-wider">页面导航</h3>
              <TableOfContentsWrapper headings={headings} />
            </div>
          </aside>
        )}
      </div>
    </div>
  </main>

  <!-- 移动端抽屉组件 -->
  <div id="mobile-drawer-container"></div>
</Layout>

<!-- Mermaid 初始化脚本 -->
<script>
  import mermaid from "mermaid";

  // 等待 DOM 加载完成
  const initMermaid = async () => {
  
    
    const isDark = document.documentElement.classList.contains("dark");

    // 初始化 Mermaid
    mermaid.initialize({
      startOnLoad: false,
      theme: isDark ? "dark" : "default",
      securityLevel: "loose",
      themeVariables: {
        darkMode: isDark,
      },
    });

    // 查找包含 mermaid 关键字的代码块
    const allCodeBlocks = document.querySelectorAll("pre code");
    const mermaidBlocks = Array.from(allCodeBlocks).filter(code => {
      const classes = code.className || "";
      const content = code.textContent || "";
      // 检查类名或内容是否包含 mermaid
      return classes.includes("mermaid") || 
             content.trim().startsWith("graph") ||
             content.trim().startsWith("sequenceDiagram") ||
             content.trim().startsWith("classDiagram") ||
             content.trim().startsWith("stateDiagram") ||
             content.trim().startsWith("erDiagram") ||
             content.trim().startsWith("gantt") ||
             content.trim().startsWith("pie") ||
             content.trim().startsWith("journey");
    });

    console.log(`Total mermaid blocks found: ${mermaidBlocks.length}`);

    for (let i = 0; i < mermaidBlocks.length; i++) {
      const block = mermaidBlocks[i];
      const code = block.textContent || "";
      console.log(`Processing block ${i + 1}:`, code.slice(0, 50));
      
      // 找到包含代码的 pre 元素
      const pre = block.closest("pre");
      
      if (pre && !pre.classList.contains("mermaid-rendered")) {
        try {
          const id = `mermaid-${Math.random().toString(36).substr(2, 9)}`;
          const { svg } = await mermaid.render(id, code);

          // 创建容器并替换
          const container = document.createElement("div");
          container.className = "mermaid-container my-6 flex justify-center";
          container.innerHTML = svg;

          pre.replaceWith(container);
          pre.classList.add("mermaid-rendered");
          console.log(`Successfully rendered block ${i + 1}`);
        } catch (error) {
          console.error(`Mermaid render error for block ${i + 1}:`, error);
        }
      }
    }
  };

  // 页面加载时初始化
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initMermaid);
  } else {
    initMermaid();
  }
</script>

<!-- 代码块复制功能 -->
<script>
  function initCodeCopy() {
    // 为所有代码块添加复制按钮
    const codeBlocks = document.querySelectorAll('.prose pre');
    
    codeBlocks.forEach((pre) => {
      // 跳过已处理的或 mermaid 图表
      if (pre.classList.contains('code-block-processed') || pre.classList.contains('mermaid-rendered')) {
        return;
      }

      // 创建包装器
      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';
      
      // 创建复制按钮
      const button = document.createElement('button');
      button.className = 'copy-button';
      button.textContent = 'Copy';
      button.setAttribute('aria-label', 'Copy code to clipboard');
      
      // 复制功能
      button.addEventListener('click', async () => {
        const code = pre.querySelector('code');
        const text = code?.textContent || '';
        
        try {
          await navigator.clipboard.writeText(text);
          button.textContent = 'Copied!';
          button.classList.add('copied');
          
          setTimeout(() => {
            button.textContent = 'Copy';
            button.classList.remove('copied');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
          button.textContent = 'Failed';
          setTimeout(() => {
            button.textContent = 'Copy';
          }, 2000);
        }
      });
      
      // 包装代码块
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);
      wrapper.appendChild(button);
      
      pre.classList.add('code-block-processed');
    });
  }

  // 初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCodeCopy);
  } else {
    initCodeCopy();
  }

  // 监听主题切换后重新初始化（如果需要）
  document.addEventListener('astro:after-swap', initCodeCopy);
</script>

<style>
  /* Scrim Gradient - 使用缓动曲线消除波浪纹 */
  /* 基于 Andreas Larsen 的研究: https://css-tricks.com/easing-linear-gradients/ */
  /* 使用项目主色 --background */
  .gradient-scrim {
    background: linear-gradient(
      to bottom,
      hsla(0, 0%, 100%, 0) 0%,
      hsla(0, 0%, 100%, 0.013) 8.1%,
      hsla(0, 0%, 100%, 0.049) 15.5%,
      hsla(0, 0%, 100%, 0.104) 22.5%,
      hsla(0, 0%, 100%, 0.175) 29%,
      hsla(0, 0%, 100%, 0.259) 35.3%,
      hsla(0, 0%, 100%, 0.352) 41.2%,
      hsla(0, 0%, 100%, 0.450) 47.1%,
      hsla(0, 0%, 100%, 0.550) 52.9%,
      hsla(0, 0%, 100%, 0.648) 58.8%,
      hsla(0, 0%, 100%, 0.741) 64.7%,
      hsla(0, 0%, 100%, 0.825) 71%,
      hsla(0, 0%, 100%, 0.896) 77.5%,
      hsla(0, 0%, 100%, 0.951) 84.5%,
      hsla(0, 0%, 100%, 0.987) 91.9%,
      hsl(0, 0%, 100%) 100%
    );
  }

  /* 暗色模式渐变 - 使用 --background: 0 0% 4% */
  :global(.dark) .gradient-scrim {
    background: linear-gradient(
      to bottom,
      hsla(0, 0%, 4%, 0) 0%,
      hsla(0, 0%, 4%, 0.013) 8.1%,
      hsla(0, 0%, 4%, 0.049) 15.5%,
      hsla(0, 0%, 4%, 0.104) 22.5%,
      hsla(0, 0%, 4%, 0.175) 29%,
      hsla(0, 0%, 4%, 0.259) 35.3%,
      hsla(0, 0%, 4%, 0.352) 41.2%,
      hsla(0, 0%, 4%, 0.450) 47.1%,
      hsla(0, 0%, 4%, 0.550) 52.9%,
      hsla(0, 0%, 4%, 0.648) 58.8%,
      hsla(0, 0%, 4%, 0.741) 64.7%,
      hsla(0, 0%, 4%, 0.825) 71%,
      hsla(0, 0%, 4%, 0.896) 77.5%,
      hsla(0, 0%, 4%, 0.951) 84.5%,
      hsla(0, 0%, 4%, 0.987) 91.9%,
      hsl(0, 0%, 4%) 100%
    );
  }

  /* 侧边栏固定效果 */
  .sidebar-container {
    transition: none; /* 移除过渡效果，避免滚动时闪烁 */
  }

  .sidebar-container.fixed {
    position: fixed;
    top: 5rem;
    z-index: 30;
    max-height: calc(100vh - 8rem);
  }

  /* 侧边栏到达底部时停止固定 */
  .sidebar-container.stop-at-bottom {
    position: absolute;
    bottom: 0;
    top: auto;
    z-index: 30;
  }

  #left-sidebar.fixed,
  #left-sidebar.stop-at-bottom {
    width: 240px;
  }

  #right-sidebar.fixed,
  #right-sidebar.stop-at-bottom {
    width: 240px;
  }

  /* 侧边栏包装器需要足够高度以支持绝对定位 */
  #left-sidebar-wrapper,
  #right-sidebar-wrapper {
    min-height: 100%;
  }

  /* Prose 标题滚动偏移 */
  :global(.prose h1[id], 
          .prose h2[id], 
          .prose h3[id], 
          .prose h4[id], 
          .prose h5[id], 
          .prose h6[id]) {
    scroll-margin-top: 6rem;
  }
</style>

<script is:inline define:vars={{ posts, projects, currentPath, isProjectPage }}>
  // 将数据存储到全局变量供 PostListDrawer 使用
  window.__ASTRO_POSTS__ = posts;
  window.__ASTRO_PROJECTS__ = projects;
</script>

<script>
  import { createRoot } from 'react-dom/client';
  import React from 'react';

  // 动态导入组件
  async function initializeDrawer() {
    try {
      const [
        { default: MobileDrawer },
        { PostListOptimized }
      ] = await Promise.all([
        import('../components/MobileDrawer.jsx'),
        import('../components/PostListOptimized')
      ]);

      // 抽屉组件
      function DrawerApp() {
        const [isOpen, setIsOpen] = React.useState(false);

        React.useEffect(() => {
          const handleDrawerToggle = () => {
            setIsOpen(prev => !prev);
          };

          window.addEventListener('togglePostListDrawer', handleDrawerToggle);
          
          return () => {
            window.removeEventListener('togglePostListDrawer', handleDrawerToggle);
          };
        }, []);

        const handleClose = () => {
          setIsOpen(false);
        };

        return React.createElement(
          MobileDrawer,
          {
            isOpen,
            onClose: handleClose,
            title: "文章列表",
            children: React.createElement(PostListOptimized, {
              posts: window.__ASTRO_POSTS__ || [],
              projects: window.__ASTRO_PROJECTS__ || [],
              currentPath: window.location.pathname,
              isProjectPage: window.location.pathname.startsWith('/project/')
            })
          }
        );
      }

      const container = document.getElementById('mobile-drawer-container');
      if (container) {
        const root = createRoot(container);
        root.render(React.createElement(DrawerApp));
      }

      window.togglePostListDrawer = () => {
        window.dispatchEvent(new CustomEvent('togglePostListDrawer'));
      };

    } catch (error) {
      console.error('Failed to initialize drawer:', error);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDrawer);
  } else {
    initializeDrawer();
  }

  // 侧边栏滚动固定效果 - 使用 requestAnimationFrame 优化性能
  function initSidebarScroll() {
    const leftSidebar = document.getElementById('left-sidebar');
    const rightSidebar = document.getElementById('right-sidebar');
    const leftWrapper = document.getElementById('left-sidebar-wrapper');
    const rightWrapper = document.getElementById('right-sidebar-wrapper');
    const contentSection = document.querySelector('.bg-background.min-h-screen');
    const footer = document.querySelector('footer, section.border-t');
    
    if (!contentSection) return;

    // 获取内容区域的初始位置
    const contentTop = contentSection.getBoundingClientRect().top + window.scrollY;
    const fixThreshold = contentTop - 20;

    let ticking = false;

    function handleScroll() {
      const scrollY = window.scrollY;
      const windowHeight = window.innerHeight;
      
      // 获取 footer 位置
      let footerTop = document.body.scrollHeight;
      if (footer) {
        footerTop = footer.getBoundingClientRect().top + scrollY;
      }
      
      // 处理左侧边栏
      if (leftSidebar && leftWrapper) {
        const wrapperRect = leftWrapper.getBoundingClientRect();
        const wrapperBottom = wrapperRect.bottom + scrollY;
        const sidebarHeight = leftSidebar.offsetHeight;
        
        // 计算侧边栏底部是否会超过 footer
        const sidebarBottom = scrollY + 80 + sidebarHeight; // 80 = 5rem top
        const shouldStop = sidebarBottom >= footerTop - 20;
        
        leftSidebar.classList.remove('fixed', 'stop-at-bottom');
        
        if (scrollY >= fixThreshold) {
          if (shouldStop) {
            leftSidebar.classList.add('stop-at-bottom');
          } else {
            leftSidebar.classList.add('fixed');
          }
        }
      }
      
      // 处理右侧边栏
      if (rightSidebar && rightWrapper) {
        const wrapperRect = rightWrapper.getBoundingClientRect();
        const wrapperBottom = wrapperRect.bottom + scrollY;
        const sidebarHeight = rightSidebar.offsetHeight;
        
        // 计算侧边栏底部是否会超过 footer
        const sidebarBottom = scrollY + 80 + sidebarHeight; // 80 = 5rem top
        const shouldStop = sidebarBottom >= footerTop - 20;
        
        rightSidebar.classList.remove('fixed', 'stop-at-bottom');
        
        if (scrollY >= fixThreshold) {
          if (shouldStop) {
            rightSidebar.classList.add('stop-at-bottom');
          } else {
            rightSidebar.classList.add('fixed');
          }
        }
      }
      
      ticking = false;
    }

    function requestTick() {
      if (!ticking) {
        requestAnimationFrame(handleScroll);
        ticking = true;
      }
    }

    // 使用 passive 事件监听器提高滚动性能
    window.addEventListener('scroll', requestTick, { passive: true });
    // 窗口大小改变时重新计算
    window.addEventListener('resize', requestTick, { passive: true });
    // 初始检查
    handleScroll();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSidebarScroll);
  } else {
    initSidebarScroll();
  }
</script>
